<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Quiniela Liga MX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="‚öΩ Quiniela Liga MX - Participa Ahora">
  <meta property="og:description" content="Haz tus pron√≥sticos de la Liga MX. üèÜ Premio Mayor para m√°s aciertos. ¬°2 pron√≥sticos por jugador!">
  <meta property="og:site_name" content="Quiniela Liga MX">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="‚öΩ Quiniela Liga MX - Participa Ahora">
  <meta name="twitter:description" content="Haz tus pron√≥sticos de la Liga MX. üèÜ Premio Mayor para m√°s aciertos.">
  
  <!-- General Meta Tags -->
  <meta name="description" content="Quiniela Liga MX - Haz tus pron√≥sticos y compite por premios. Sistema de doble entrada con premio mayor.">
  <meta name="keywords" content="quiniela, liga mx, futbol, pronosticos, predicciones">

  <style>
    :root{
      --bg:#0f1220;
      --card:#171a2f;
      --line:#2a2e52;
      --accent:#7c9cff;
      --ok:#35d49a;
      --bad:#ff6b6b;
      --txt:#e9ecff;
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#0c0f1d,#12152b);
      color:var(--txt);
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      margin-bottom:14px;
    }
    h1,h2,h3{margin:.2em 0 .6em 0}
    .small{opacity:.85;font-size:13px}
    input,select,button{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0c0f1d;
      color:var(--txt);
      font-size:16px;
      box-sizing:border-box;
      -webkit-appearance:none;
      -moz-appearance:none;
      appearance:none;
      transition:all 0.2s ease;
    }
    input:focus,select:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(124,156,255,0.2);
    }
    input:disabled,select:disabled{
      opacity:0.6;
      cursor:not-allowed;
    }
    button{
      background:linear-gradient(180deg,#6f8cff,#5a74ff);
      border:none;
      font-weight:800;
      cursor:pointer;
      touch-action:manipulation; /* Prevents double-tap zoom on mobile */
    }
    button:active{
      transform:scale(0.98);
      opacity:0.9;
    }
    button:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    button.secondary{
      background:#0c0f1d;
      border:1px solid var(--line);
      font-weight:700;
    }
    button.secondary:active{
      background:rgba(255,255,255,0.05);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    th,td{
      padding:8px;
      border-bottom:1px solid var(--line);
      text-align:left;
    }
    th{
      opacity:.8;
      font-weight:700;
      position:sticky;
      top:0;
      background:var(--card);
      z-index:1;
    }
    td{
      vertical-align:middle;
    }
    /* Responsive table wrapper */
    .table-wrapper{
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      margin:10px 0;
    }
    .center{text-align:center}
    .ok{color:var(--ok)}
    .bad{color:var(--bad)}

    /* Partido header */
    .matchHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
    }
    .team{
      display:flex; align-items:center; gap:8px; min-width:0;
    }
    .team span{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px;}
    .logo{
      width:26px; height:26px; border-radius:50%;
      background:#0c0f1d; border:1px solid var(--line);
      object-fit:contain;
    }
    .vs{opacity:.8; font-weight:800}
    
    /* Etiquetas Local/Visitante */
    .team-label{
      font-weight:400;
      opacity:0.7;
      font-size:13px;
    }

    /* ‚úÖ Dos picks lado a lado */
    .twoCols{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .miniCard{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.03);
    }
    .miniTitle{font-weight:900;margin-bottom:8px}
    .locked{
      opacity:.6;
      filter:grayscale(1);
    }
    .decimo-badge{
      background:#7c9cff;
      color:#fff;
      padding:4px 8px;
      border-radius:6px;
      font-size:12px;
      font-weight:900;
      display:inline-block;
      margin-bottom:6px;
    }
    
    /* Campo faltante - marcado en rojo */
    .field-missing{
      border:2px solid var(--bad) !important;
      animation:shake 0.3s ease;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    /* ===== TABLA QUINIELA ===== */
    .quiniela-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .quiniela-table thead tr {
      background: rgba(124, 156, 255, 0.15);
    }
    
    .quiniela-table th {
      padding: 14px 10px;
      font-weight: 700;
      font-size: 13px;
      text-align: center;
      border-bottom: 2px solid var(--line);
      position: sticky;
      top: 0;
      background: rgba(124, 156, 255, 0.15);
      z-index: 10;
    }
    
    .quiniela-table td {
      padding: 12px 10px;
      border-bottom: 1px solid var(--line);
      vertical-align: middle;
    }
    
    .quiniela-table tbody tr:hover:not(.separator-row):not(.locked) {
      background: rgba(255, 255, 255, 0.03);
    }
    
    /* Checkbox Cell */
    .checkbox-cell {
      text-align: center;
      width: 70px;
      padding: 8px !important;
    }
    
    .checkbox-cell input[type="checkbox"] {
      width: 24px;
      height: 24px;
      cursor: pointer;
      margin: 0;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      border: 2px solid var(--line);
      border-radius: 50%; /* Circular checkboxes */
      background: rgba(255,255,255,0.05);
      transition: all 0.2s ease;
      position: relative;
    }
    
    .checkbox-cell input[type="checkbox"]:hover {
      border-color: #35d49a; /* Green hover */
      background: rgba(53,212,154,0.1);
    }
    
    .checkbox-cell input[type="checkbox"]:checked {
      background: linear-gradient(135deg, #35d49a, #2ab882); /* Green gradient */
      border-color: #2ab882;
      box-shadow: 0 0 0 3px rgba(53,212,154,0.3); /* Green glow */
    }
    
    .checkbox-cell input[type="checkbox"]:checked::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 16px;
      font-weight: bold;
    }
    
    .checkbox-cell input[type="checkbox"]:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    /* Team Cell */
    .team-cell {
      padding: 10px 12px !important;
    }
    
    .team-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .team-info .logo {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .team-info .team-name {
      font-weight: 600;
      font-size: 14px;
      line-height: 1.3;
    }
    
    /* Separator Row */
    .separator-row {
      background: linear-gradient(90deg, var(--accent), #5a74ff) !important;
      text-align: center;
      font-weight: 900;
      font-size: 15px;
      color: #fff !important;
      height: 50px;
    }
    
    .separator-row td {
      border: none !important;
      padding: 12px !important;
      text-align: center;
    }
    
    .separator-row:hover {
      background: linear-gradient(90deg, var(--accent), #5a74ff) !important;
    }
    
    /* Locked Row */
    .quiniela-table tr.locked {
      opacity: 0.45;
      background: rgba(255, 255, 255, 0.01);
    }
    
    .quiniela-table tr.locked .team-name {
      color: #999;
    }
    
    /* Missing Pick Highlight */
    .quiniela-table tr.pick-missing {
      background: rgba(255, 107, 107, 0.12) !important;
      animation: shake 0.3s ease;
    }
    
    .quiniela-table tr.pick-missing td {
      border-color: var(--bad) !important;
    }
    
    /* ===== RESPONSIVE DESIGN ===== */
    
    /* Tablets and smaller desktops (768px - 1024px) */
    @media(max-width:1024px){
      .wrap{max-width:100%;padding:20px}
      h1{font-size:1.8em}
      h2{font-size:1.5em}
    }
    
    /* Tablets (700px - 768px) */
    @media(max-width:768px){
      .wrap{padding:16px}
      h1{font-size:1.6em}
      h2{font-size:1.3em}
      .team span{max-width:160px;}
      table{font-size:13px}
      th,td{padding:6px}
    }
    
    /* Mobile devices (below 700px) */
    @media(max-width:700px){
      .twoCols{grid-template-columns:1fr;}
      .team span{max-width:140px;}
      .wrap{padding:12px}
      h1{font-size:1.5em;margin:.2em 0 .4em 0}
      h2{font-size:1.2em;margin:.2em 0 .4em 0}
      h3{font-size:1.1em}
      
      /* Touch-friendly buttons and inputs */
      input,select,button{
        padding:14px 12px;
        font-size:16px;
        min-height:48px; /* Better touch target - WCAG 2.1 guideline */
      }
      
      button{
        margin-top:8px;
        font-size:17px;
      }
      
      /* Card spacing */
      .card{
        padding:12px;
        margin-bottom:12px;
        border-radius:12px;
      }
      
      .miniCard{
        padding:8px;
        border-radius:10px;
      }
      
      /* Match header adjustments */
      .matchHead{
        flex-direction:column;
        gap:8px;
        text-align:center;
      }
      
      .team{
        justify-content:center;
        width:100%;
      }
      
      .logo{
        width:32px;
        height:32px; /* Larger logos on mobile */
      }
      
      .vs{
        font-size:14px;
        margin:4px 0;
      }
      
      /* Table responsive */
      .table-wrapper,table{
        font-size:12px;
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
      }
      
      table{
        display:block;
      }
      
      th,td{
        padding:8px 4px;
        white-space:nowrap;
      }
      
      /* Small text legibility */
      .small{
        font-size:14px;
        line-height:1.4;
      }
      
      .miniTitle{
        font-size:15px;
      }
    }
    
    /* Extra small devices (below 400px) */
    @media(max-width:400px){
      .wrap{padding:10px}
      h1{font-size:1.3em}
      h2{font-size:1.1em}
      
      .team span{
        max-width:100px;
        font-size:14px;
      }
      
      .logo{
        width:28px;
        height:28px;
      }
      
      input,select,button{
        padding:12px;
        font-size:15px;
      }
      
      .card{
        padding:10px;
        border-radius:10px;
      }
      
      table{font-size:11px}
      th,td{padding:6px 2px}
    }
    
    /* Landscape orientation on mobile */
    @media(max-height:500px) and (orientation:landscape){
      .wrap{padding:8px}
      h1{font-size:1.2em;margin:.1em 0 .3em 0}
      h2{font-size:1em;margin:.1em 0 .3em 0}
      .card{padding:8px;margin-bottom:8px}
      input,select,button{padding:10px}
    }
  </style>
</head>

<body>
<div class="wrap">

  <h1>‚öΩ Quiniela Liga MX</h1>

  <!-- REGISTRO -->
  <div class="card" id="registerCard">
    <h2>Reg√≠strate</h2>
    <div class="small">Tu nombre debe ser √∫nico (no se permiten repetidos)</div>
    <input id="regNombre" placeholder="Tu nombre">
    <div style="margin-top:10px">
      <button onclick="register()">Entrar</button>
    </div>
    <div id="regMsg" class="small" style="margin-top:8px"></div>
  </div>

  <!-- FORMULARIO -->
  <div class="card" id="formCard" style="display:none">
    <h2 id="jorTitle"></h2>
    <div class="small">Tienes <strong>2 pron√≥sticos</strong>. Cada uno compite por separado. Incluye hasta 10 partidos (9 Liga MX + 1 partido extra opcional).</div>

    <!-- INFO DE PREMIOS -->
    <div style="margin-top:12px;padding:12px;background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:10px">
      <div class="small" style="line-height:1.6">
        <strong style="color:var(--ok)">üèÜ Premio Mayor:</strong> <span id="premioMayorMonto" style="color:var(--ok)">$0</span> - Quien acierte m√°s resultados (L/V/E). Si hay empate, se reparte.
      </div>
      <div id="prizePoolInfo" class="small" style="margin-top:8px;opacity:.7"></div>
    </div>

    <div id="picksBox" style="margin-top:10px"></div>

    <button style="margin-top:12px" onclick="submitAll()">Guardar pron√≥sticos</button>
    <div id="saveMsg" class="small" style="margin-top:8px"></div>

    <div style="margin-top:14px">
      <button class="secondary" onclick="openTabla()">üìä Ver tabla / transparencia</button>
    </div>
  </div>

  <!-- TABLA -->
  <div class="card" id="tablaCard" style="display:none">
    <h2>üìä Resultados</h2>
    <div id="premioMayorBox"></div>

    <button class="secondary" style="margin-bottom:10px" onclick="loadTabla()">Ver tabla general</button>
    <button class="secondary" style="margin-bottom:10px" onclick="loadTransparencia()">üëÄ Ver todos los picks</button>

    <div id="tablaBox"></div>
  </div>

</div>

<script>
let SESSION = { token:null, jornada:null, lockMinutes:10, partidos:[] };

// Constantes para validaci√≥n de picks
const VALID_PICK_VALUES = ["L", "E", "V"];

function esc(s){return String(s||"").replace(/[&<>"]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m]))}

/* ---------- TOKEN VALIDATION ---------- */
function validateTokenAndBootstrap(token){
  google.script.run
    .withSuccessHandler(loginR=>{
      if(!loginR || !loginR.ok){
        document.getElementById("regMsg").innerHTML = `<span class="bad">Error al validar: ${esc(loginR?.error || "desconocido")}</span>`;
        return;
      }
      document.getElementById("regMsg").innerHTML = `<span class="ok">‚úÖ Registro exitoso. Cargando predicciones...</span>`;
      bootstrap();
    })
    .withFailureHandler(err=>{
      document.getElementById("regMsg").innerHTML = `<span class="bad">Error de conexi√≥n: ${esc(err?.message || "intenta de nuevo")}</span>`;
    })
    .api_loginByToken(token);
}

/* ---------- REGISTRO ---------- */
function register(){
  const nombre = document.getElementById("regNombre").value.trim();
  if(!nombre) return;

  document.getElementById("regMsg").innerHTML = "Registrando‚Ä¶";

  google.script.run
    .withSuccessHandler(r=>{
      if(!r.ok){
        document.getElementById("regMsg").innerHTML = `<span class="bad">${esc(r.error)}</span>`;
        return;
      }
      SESSION.token = r.token;
      localStorage.setItem("q_token", r.token);
      validateTokenAndBootstrap(r.token);
    })
    .withFailureHandler(err=>{
      document.getElementById("regMsg").innerHTML = `<span class="bad">Error de conexi√≥n: ${esc(err?.message || "intenta de nuevo")}</span>`;
    })
    .api_register(nombre);
}

/* ---------- BOOTSTRAP ---------- */
function bootstrap(){
  console.log("üöÄ bootstrap() called, SESSION.token:", SESSION.token ? "present" : "missing");
  const t = localStorage.getItem("q_token");
  if(t) SESSION.token = t;

  google.script.run
    .withSuccessHandler(r=>{
      console.log("‚úÖ api_bootstrap success:", r);
      if(!r || !r.ok){
        console.error("‚ùå api_bootstrap failed:", r);
        document.getElementById("regMsg").innerHTML = `<span class="bad">No pude cargar la jornada.</span>`;
        return;
      }

      console.log("üìä Bootstrap data received:", r);
      SESSION.jornada = r.jornada;
      SESSION.lockMinutes = r.lockMinutes || 10;
      SESSION.partidos = r.partidos || [];

      console.log("üìã Partidos loaded:", SESSION.partidos.length);
      
      // Validaci√≥n: Verificar que SESSION.partidos se llen√≥ correctamente
      if(!SESSION.partidos || SESSION.partidos.length === 0){
        console.error("‚õî ERROR: SESSION.partidos est√° vac√≠o despu√©s del bootstrap");
        document.getElementById("regMsg").innerHTML = `<span class="bad">‚õî Error: No se pudieron cargar los partidos. Contacta al administrador.</span>`;
        return;
      }
      
      console.log("‚úÖ SESSION.partidos cargado correctamente con", SESSION.partidos.length, "partidos");

      // si no hay token, que se registre
      if(!SESSION.token){
        console.log("‚ÑπÔ∏è No token found, showing registration");
        document.getElementById("registerCard").style.display = "block";
        document.getElementById("formCard").style.display = "none";
        return;
      }

      console.log("‚úÖ Token found, showing form");
      document.getElementById("registerCard").style.display = "none";
      document.getElementById("formCard").style.display = "block";
      document.getElementById("jorTitle").innerHTML = `Jornada ${r.jornada}`;

      console.log("üìù Calling renderForm()");
      renderForm();
      console.log("üì• Calling loadMyPicks()");
      loadMyPicks();
      console.log("üí∞ Calling loadPrizePool()");
      loadPrizePool();
      console.log("‚úÖ bootstrap() completed successfully");
    })
    .withFailureHandler(err=>{
      console.error("‚ùå api_bootstrap error:", err);
      document.getElementById("regMsg").innerHTML = `<span class="bad">Error al cargar: ${esc(err?.message || "intenta recargar la p√°gina")}</span>`;
    })
    .api_bootstrap();
}

/* ---------- FORMULARIO ---------- */
function generateMatchKey(jornada, local, visit){
  return `${jornada}|${local}`.toLowerCase() + `|${visit}`.toLowerCase();
}

function loadMyPicks(){
  if(!SESSION.token || !SESSION.jornada) return;

  // Load picks for both entries
  loadPicksForEntry(1);
  loadPicksForEntry(2);
}

function loadPicksForEntry(entry){
  google.script.run
    .withSuccessHandler(r=>{
      if(r && r.ok && r.picks){
        fillPicksInForm(r.picks, entry);
      } else {
        console.warn(`No picks data for entry ${entry}:`, r);
      }
    })
    .withFailureHandler(err=>{
      console.error(`Error loading picks entry ${entry}:`, err);
    })
    .api_getMyPicks(SESSION.token, SESSION.jornada, entry);
}

function fillPicksInForm(picks, entry){
  const partidos = SESSION.partidos.slice(0, 10);
  
  partidos.forEach((p, idx) => {
    const key = generateMatchKey(SESSION.jornada, p.local, p.visit);
    const saved = picks[key];
    if(!saved || !saved.pick) return;

    // Marcar el checkbox correspondiente (L, E, o V)
    const checkboxId = `pick_${saved.pick}_${idx}_${entry}`;
    const checkbox = document.getElementById(checkboxId);
    if(checkbox){
      checkbox.checked = true;
    }
  });
}

function renderForm(){
  console.log("üìã renderForm() called");
  const box = document.getElementById("picksBox");
  if(!box){
    console.error("‚ùå Element 'picksBox' not found");
    return;
  }
  
  if(!SESSION.partidos || SESSION.partidos.length === 0){
    console.error("‚ùå SESSION.partidos is empty:", SESSION.partidos);
    box.innerHTML = `<div class="small bad">No hay partidos cargados para esta jornada.</div>`;
    return;
  }

  console.log("‚úÖ Rendering form with", SESSION.partidos.length, "partidos");
  
  // Tomar solo primeros 10 partidos (m√°ximo)
  const partidos = SESSION.partidos.slice(0, 10);

  let html = `
    <div class="table-wrapper">
      <table class="quiniela-table">
        <thead>
          <tr>
            <th class="checkbox-cell">Local</th>
            <th>Equipo Local</th>
            <th class="checkbox-cell">Empate</th>
            <th>Equipo Visitante</th>
            <th class="checkbox-cell">Visitante</th>
          </tr>
        </thead>
        <tbody>
  `;

  // ENTRY 1: Primeros 10 partidos
  partidos.forEach((p, idx) => {
    const locked = !!p.locked;
    const rowClass = locked ? 'locked' : '';
    
    html += `
      <tr class="${rowClass}" data-idx="${idx}" data-entry="1">
        <td class="checkbox-cell">
          <input type="checkbox" 
                 id="pick_L_${idx}_1" 
                 name="pick_${idx}_1" 
                 value="L" 
                 ${locked ? 'disabled' : ''}
                 onchange="handleCheckboxChange(${idx}, 1, 'L')">
        </td>
        <td class="team-cell">
          <div class="team-info">
            ${p.logoLocal ? `<img class="logo" src="${esc(p.logoLocal)}" alt="">` : ''}
            <span class="team-name">${esc(p.local)}</span>
          </div>
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" 
                 id="pick_E_${idx}_1" 
                 name="pick_${idx}_1" 
                 value="E" 
                 ${locked ? 'disabled' : ''}
                 onchange="handleCheckboxChange(${idx}, 1, 'E')">
        </td>
        <td class="team-cell">
          <div class="team-info" style="justify-content:flex-end">
            <span class="team-name">${esc(p.visit)}</span>
            ${p.logoVisit ? `<img class="logo" src="${esc(p.logoVisit)}" alt="">` : ''}
          </div>
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" 
                 id="pick_V_${idx}_1" 
                 name="pick_${idx}_1" 
                 value="V" 
                 ${locked ? 'disabled' : ''}
                 onchange="handleCheckboxChange(${idx}, 1, 'V')">
        </td>
      </tr>
    `;
  });

  // SEPARATOR: QUINIELA 2X1
  html += `
    <tr class="separator-row">
      <td colspan="5">‚öΩ QUINIELA 2X1 ‚öΩ</td>
    </tr>
  `;

  // ENTRY 2: Mismos 10 partidos repetidos
  partidos.forEach((p, idx) => {
    const locked = !!p.locked;
    const rowClass = locked ? 'locked' : '';
    
    html += `
      <tr class="${rowClass}" data-idx="${idx}" data-entry="2">
        <td class="checkbox-cell">
          <input type="checkbox" 
                 id="pick_L_${idx}_2" 
                 name="pick_${idx}_2" 
                 value="L" 
                 ${locked ? 'disabled' : ''}
                 onchange="handleCheckboxChange(${idx}, 2, 'L')">
        </td>
        <td class="team-cell">
          <div class="team-info">
            ${p.logoLocal ? `<img class="logo" src="${esc(p.logoLocal)}" alt="">` : ''}
            <span class="team-name">${esc(p.local)}</span>
          </div>
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" 
                 id="pick_E_${idx}_2" 
                 name="pick_${idx}_2" 
                 value="E" 
                 ${locked ? 'disabled' : ''}
                 onchange="handleCheckboxChange(${idx}, 2, 'E')">
        </td>
        <td class="team-cell">
          <div class="team-info" style="justify-content:flex-end">
            <span class="team-name">${esc(p.visit)}</span>
            ${p.logoVisit ? `<img class="logo" src="${esc(p.logoVisit)}" alt="">` : ''}
          </div>
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" 
                 id="pick_V_${idx}_2" 
                 name="pick_${idx}_2" 
                 value="V" 
                 ${locked ? 'disabled' : ''}
                 onchange="handleCheckboxChange(${idx}, 2, 'V')">
        </td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
    </div>
  `;

  console.log("‚úÖ Generated HTML, setting innerHTML");
  box.innerHTML = html;
  console.log("‚úÖ innerHTML set, loading picks");
  
  // Cargar picks guardados
  loadPicksForEntry(1);
  loadPicksForEntry(2);
  
  console.log("‚úÖ renderForm() completed");
}

/* ---------- CHECKBOX HANDLER ---------- */
function handleCheckboxChange(idx, entry, value){
  // Primero, asegurar que el checkbox clickeado est√© marcado
  const currentCheckbox = document.getElementById(`pick_${value}_${idx}_${entry}`);
  if(currentCheckbox){
    currentCheckbox.checked = true;
  }
  
  // Desmarcar los otros checkboxes del mismo partido y entry
  const otherValues = ['L', 'E', 'V'].filter(v => v !== value);
  
  otherValues.forEach(v => {
    const checkbox = document.getElementById(`pick_${v}_${idx}_${entry}`);
    if(checkbox){
      checkbox.checked = false;
    }
  });
  
  // Limpiar marcas rojas si exist√≠an
  const row = document.querySelector(`tr[data-idx="${idx}"][data-entry="${entry}"]`);
  if(row){
    row.classList.remove('pick-missing');
  }
}

/* ---------- SUBMIT (arreglado) ---------- */
function submitAll(){
  const saveMsg = document.getElementById("saveMsg");
  saveMsg.innerHTML = "Guardando‚Ä¶";

  // Limpiar marcas rojas previas
  document.querySelectorAll('.pick-missing').forEach(el => el.classList.remove('pick-missing'));

  // Validaci√≥n: Verificar que SESSION.partidos est√© poblado
  if(!SESSION.partidos || SESSION.partidos.length === 0){
    saveMsg.innerHTML = `<span class="bad">‚õî Error: No hay partidos cargados.</span>`;
    console.error("SESSION.partidos est√° vac√≠o:", SESSION.partidos);
    return;
  }

  const partidos = SESSION.partidos.slice(0, 10);
  const picks1 = [];
  const picks2 = [];

  partidos.forEach((p, idx) => {
    // Entry 1 - Leer checkboxes
    const pickL1 = document.getElementById(`pick_L_${idx}_1`)?.checked;
    const pickE1 = document.getElementById(`pick_E_${idx}_1`)?.checked;
    const pickV1 = document.getElementById(`pick_V_${idx}_1`)?.checked;
    
    let pick1 = "";
    if(pickL1) pick1 = "L";
    else if(pickE1) pick1 = "E";
    else if(pickV1) pick1 = "V";
    
    picks1.push({ local: p.local, visit: p.visit, pick: pick1, gl: "", gv: "" });

    // Entry 2 - Leer checkboxes
    const pickL2 = document.getElementById(`pick_L_${idx}_2`)?.checked;
    const pickE2 = document.getElementById(`pick_E_${idx}_2`)?.checked;
    const pickV2 = document.getElementById(`pick_V_${idx}_2`)?.checked;
    
    let pick2 = "";
    if(pickL2) pick2 = "L";
    else if(pickE2) pick2 = "E";
    else if(pickV2) pick2 = "V";
    
    picks2.push({ local: p.local, visit: p.visit, pick: pick2, gl: "", gv: "" });
  });

  // Validaci√≥n: Verificar que hay al menos un pick v√°lido
  const validPicks1 = picks1.filter(p => p.pick && VALID_PICK_VALUES.includes(p.pick));
  const validPicks2 = picks2.filter(p => p.pick && VALID_PICK_VALUES.includes(p.pick));

  if(validPicks1.length === 0 && validPicks2.length === 0){
    saveMsg.innerHTML = `<span class="bad">‚õî No hay picks para guardar. Selecciona al menos un resultado.</span>`;
    console.warn("No se encontraron picks v√°lidos. Entry 1:", validPicks1.length, "Entry 2:", validPicks2.length);
    
    // Marcar filas sin picks en rojo
    partidos.forEach((p, idx) => {
      const row1 = document.querySelector(`tr[data-idx="${idx}"][data-entry="1"]`);
      const row2 = document.querySelector(`tr[data-idx="${idx}"][data-entry="2"]`);
      
      if(row1 && !picks1[idx].pick) row1.classList.add('pick-missing');
      if(row2 && !picks2[idx].pick) row2.classList.add('pick-missing');
    });
    
    // Scroll al primer faltante
    const firstMissing = document.querySelector('.pick-missing');
    if(firstMissing){
      firstMissing.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    return;
  }

  // Marcar filas incompletas si hay picks parciales
  const hasAnyPick1 = validPicks1.length > 0;
  const hasAnyPick2 = validPicks2.length > 0;
  
  if(hasAnyPick1){
    partidos.forEach((p, idx) => {
      if(!picks1[idx].pick){
        const row = document.querySelector(`tr[data-idx="${idx}"][data-entry="1"]`);
        if(row && !row.classList.contains('locked')){
          row.classList.add('pick-missing');
        }
      }
    });
  }
  
  if(hasAnyPick2){
    partidos.forEach((p, idx) => {
      if(!picks2[idx].pick){
        const row = document.querySelector(`tr[data-idx="${idx}"][data-entry="2"]`);
        if(row && !row.classList.contains('locked')){
          row.classList.add('pick-missing');
        }
      }
    });
  }
  
  // Verificar si hay campos faltantes marcados
  const hasMissingFields = document.querySelectorAll('.pick-missing').length > 0;
  if(hasMissingFields){
    const firstMissing = document.querySelector('.pick-missing');
    if(firstMissing){
      firstMissing.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  // Enviar a API
  google.script.run
    .withSuccessHandler(r => {
      if(!r || !r.ok){
        saveMsg.innerHTML = `<span class="bad">‚õî ${esc(r?.error || "Error")}</span>`;
        return;
      }

      const detail = r.detail || {};
      const r1 = detail.entry1 || { created:0, updated:0, blocked:0 };
      const r2 = detail.entry2 || { created:0, updated:0, blocked:0 };
      
      saveMsg.innerHTML =
        `<span class="ok" style="font-size:18px;font-weight:900">üéâ ¬°Tu quiniela ha sido guardada, suerte!!!</span>
         <div class="small" style="margin-top:6px">Entry 1: ${r1.created+r1.updated} ¬∑ Entry 2: ${r2.created+r2.updated}</div>
         ${(r1.blocked||0) + (r2.blocked||0) > 0 ? `<div class="small">Bloqueados: ${ (r1.blocked||0) + (r2.blocked||0) }</div>` : ''}`;
      
      // Limpiar marcas rojas
      document.querySelectorAll('.pick-missing').forEach(el => el.classList.remove('pick-missing'));
    })
    .withFailureHandler(err => {
      saveMsg.innerHTML = `<span class="bad">‚õî Error: ${esc(err?.message || "intenta de nuevo")}</span>`;
      console.error("Error al guardar picks:", err);
    })
    .api_submit({ 
      token: SESSION.token, 
      jornada: SESSION.jornada, 
      picks1: picks1,
      picks2: picks2
    });
}

function loadPrizePoolInfo(){
  google.script.run.withSuccessHandler(r=>{
    if(!r || !r.ok) return;
    
    const premioMayorEl = document.getElementById("premioMayorMonto");
    const infoEl = document.getElementById("prizePoolInfo");
    
    if(premioMayorEl) premioMayorEl.innerHTML = `$${r.premioMayor.toLocaleString()}`;
    
    if(infoEl && r.jugadoresPagados > 0){
      infoEl.innerHTML = `${r.jugadoresPagados} participante${r.jugadoresPagados > 1 ? 's' : ''} ¬∑ Bolsa total: $${r.poolPremios.toLocaleString()}`;
    } else if(infoEl) {
      infoEl.innerHTML = `Esperando participantes...`;
    }
  }).api_getPrizePool();
}

/* ---------- TABLA / TRANSPARENCIA ---------- */
function openTabla(){
  document.getElementById("tablaCard").style.display = "block";
  loadPremioMayor();
  loadTabla();
}

function loadPremioMayor(){
  const box = document.getElementById("premioMayorBox");
  box.innerHTML = "";

  google.script.run.withSuccessHandler(r=>{
    if(!r || !r.ok){
      box.innerHTML = `<div class="small bad">üèÜ Premio mayor: ${esc(r?.error || "No disponible (cierra la jornada)")}</div>`;
      return;
    }
    if(!r.winners || !r.winners.length){
      box.innerHTML = `<div class="small">üèÜ Premio mayor: (sin datos)</div>`;
      return;
    }
    
    const ganadores = r.winners.map(w => `${esc(w.nombre)} (Entry ${esc(w.entry)})`).join(', ');
    const compartido = r.winners.length > 1 ? ` <span class="small">(premio compartido)</span>` : '';
    
    box.innerHTML = `
      <div class="card" style="background:rgba(53,212,154,.1);border-color:#35d49a;margin-bottom:10px">
        üèÜ <strong>Premio Mayor - M√°s Aciertos</strong>${compartido}<br>
        Ganador${r.winners.length > 1 ? 'es' : ''}: <strong>${ganadores}</strong><br>
        Aciertos: <strong>${esc(r.maxAciertos)}</strong><br>
        <div class="small" style="margin-top:6px;opacity:.9">Premio al que tenga m√°s aciertos en resultados (L/V/E). Si hay empate, se reparte el premio.</div>
      </div>
    `;
  }).api_getPremioMayor(SESSION.jornada);
}

function loadTabla(){
  const box = document.getElementById("tablaBox");
  box.innerHTML = `<div class="small">Cargando tabla‚Ä¶</div>`;

  google.script.run.withSuccessHandler(r=>{
    if(!r || !r.ok){
      box.innerHTML = `<div class="small bad">‚õî ${esc(r?.error || "No disponible")}</div>`;
      return;
    }

    let html = `<table><thead><tr><th>#</th><th>Entry</th><th>Nombre</th><th class="center">Pts</th></tr></thead><tbody>`;
    (r.rows||[]).forEach(x=>{
      html += `<tr>
        <td>${x.pos}</td>
        <td class="center">${esc(x.entry)}</td>
        <td>${esc(x.nombre)}</td>
        <td class="center"><strong>${esc(x.puntos)}</strong></td>
      </tr>`;
    });
    html += `</tbody></table>`;

    box.innerHTML = html;
  }).api_getTablaGeneral();
}

function loadTransparencia(){
  const box = document.getElementById("tablaBox");
  box.innerHTML = `<div class="small">Cargando transparencia‚Ä¶</div>`;

  google.script.run.withSuccessHandler(r=>{
    if(!r || !r.ok){
      box.innerHTML = `<div class="small bad">‚õî ${esc(r?.error || "No disponible (cierra la jornada)")}</div>`;
      return;
    }

    let html = `<div class="small" style="margin-bottom:10px">Transparencia ‚Äî Jornada ${esc(r.jornada)}</div>`;

    (r.rows||[]).forEach(u=>{
      html += `
        <div class="card" style="background:rgba(255,255,255,.03)">
          <div style="font-weight:900;margin-bottom:8px">
            ${esc(u.nombre)} ‚Äî Entry ${esc(u.entry)}
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Partido</th>
                  <th class="center">Pick</th>
                  <th class="center">Marcador</th>
                  <th class="center">Real</th>
                </tr>
              </thead>
              <tbody>
                ${(u.picks||[]).map(p=>`
                  <tr>
                    <td>${esc(p.local)} vs ${esc(p.visit)}</td>
                    <td class="center"><strong>${esc(p.pick || "‚Äî")}</strong></td>
                    <td class="center">${esc(p.pickMarc || "‚Äî")}</td>
                    <td class="center">${esc(p.marcadorReal || "‚Äî")}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        </div>
      `;
    });

    box.innerHTML = html;
  }).api_getTransparenciaPicks(SESSION.jornada);
}

/* ---------- EXPONER FUNCIONES AL √ÅMBITO GLOBAL ---------- */
// Necesario para que onclick handlers puedan acceder a estas funciones
window.register = register;
window.submitAll = submitAll;
window.openTabla = openTabla;
window.loadTabla = loadTabla;
window.loadTransparencia = loadTransparencia;
window.handleCheckboxChange = handleCheckboxChange;
window.loadPrizePoolInfo = loadPrizePoolInfo;

/* ---------- AUTO ---------- */
window.onload = bootstrap;
</script>
</body>
</html>
